name: Notify Result by Discord
description: workflow ìˆ˜í–‰ ê²°ê³¼ë¥¼ Discord ì±„ë„ì— ì „ì†¡

inputs:
  failed_jobs:
    required: true
    description: ì‹¤íŒ¨í•œ job ë‚´ì—­.(ex. job1,job2)
  title:
    required: true
    description: ì™„ë£Œ/ì‹¤íŒ¨ì— ëŒ€í•œ ì œëª©
  discord_webhook_url:
    required: true
    description: Discord ì›¹í›… url
  version:
    required: false
    description: ë°°í¬í•œ ë²„ì „
  notify_success:
    required: false
    default: "true"
    description: ì„±ê³µí•œ ë‚´ì—­ ì•Œë¦¼ ë³´ë‚¼ì§€ ì—¬ë¶€

runs:
  using: "composite"
  steps:
    - name: Create Message
      id: create-message
      run: |
        github_url="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        message=""

        if [[ "${{ inputs.failed_jobs }}" != "" ]]; then
          jobs="${{ inputs.failed_jobs }}"
          formatted_jobs=""
          IFS=',' read -ra JOB_ARRAY <<< "$jobs"
          for job in "${JOB_ARRAY[@]}"; do
            formatted_jobs+="  - $job\n"
          done

          message="**[ğŸ˜¢ ë°°í¬ ì‹¤íŒ¨]**\n"
          message+="- ì„œë¹„ìŠ¤: \`${{ inputs.title }}\`\n"
          message+="- ì‹¤íŒ¨í•œ job:\n$formatted_jobs"
          message+="ğŸ‘‰ [workflow í™•ì¸]($github_url)"
        elif [[ "${{ inputs.notify_success }}" == "true" ]]; then
          message="**[ğŸ£ ë°°í¬ ì„±ê³µ]**\n"
          message+="- ì„œë¹„ìŠ¤: \`${{ inputs.title }}\`\n"
          if [[ -n "${{ inputs.version }}" ]]; then
            message+="- ë²„ì „: \`${{ inputs.version }}\`\n"
          fi
        fi

        echo "message<<EOF" >> $GITHUB_OUTPUT
        echo -e "$message" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
      shell: bash

    - name: Send message
      if: ${{ steps.create-message.outputs.message != '' }}
      env:
        RAW_MESSAGE: ${{ steps.create-message.outputs.message }}
        DISCORD_WEBHOOK_URL: ${{ inputs.discord_webhook_url }}
      run: |
        message=$(echo "$RAW_MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
        curl -H "Content-Type: application/json" \
             -X POST \
             -d "{\"content\": \"$message\"}" \
             "$DISCORD_WEBHOOK_URL"
      shell: bash
      